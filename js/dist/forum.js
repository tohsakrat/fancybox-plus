(()=>{var t={n:e=>{var r=e&&e.__esModule?()=>e.default:()=>e;return t.d(r,{a:r}),r},d:(e,r)=>{for(var n in r)t.o(r,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:r[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};(()=>{"use strict";t.r(e);const r=flarum.core.compat["forum/app"];var n=t.n(r);const a=flarum.core.compat["common/extend"],o=flarum.core.compat["forum/components/CommentPost"];var s=t.n(o);const i=flarum.core.compat["forum/components/DiscussionPage"];var l=t.n(i);const u=flarum.core.compat["forum/resolvers/DiscussionPageResolver"];var c=t.n(u);const d=flarum.core.compat["forum/components/PostStreamScrubber"];var p=t.n(d);flarum.core.compat["forum/components/PostStream"],n().initializers.add("mypost",(function(){(0,a.extend)(s().prototype,"oncreate",(function(){var t=this,e=function(t){var e=new RegExp(/[\x21-\x2f\x3a-\x40\x5b-\x60\x7B-\x7F]/);return t.replace(e,"-").replaceAll(" ","-")};Array.prototype.slice.call(this.element.querySelectorAll('a[target="_self"]')).forEach((function(t){-1!=t.href.indexOf(window.location.href.split("/").splice(0,4).join("/"))&&(t.onclick=function(e){return e.preventDefault(),n().current.data.stream.goToNumber(t.href.split("/")[5].split("#")[0]).then((function(){t.href.split("/")[5]&&setTimeout((function(){window.location.hash="#"+t.href.split("#")[1],setTimeout((function(){m.redraw()}),100)}),500)})),!1})}));var r=Array.prototype.slice.call(this.element.querySelectorAll(".Post-body :is(h1, h2, h3, h4, h5, h6)"));r.forEach((function(t,n){for(var a=t;!(a=a.parentNode).dataset.number;);t.innerHTML='<span class="title-anchor"></span><span class="title-sub-anchor">'+t.innerHTML+"</span>",t.dataset.id=a.dataset.number+"-"+e(t.innerText)+"-"+(1==r.map((function(t){return e(t.innerText)})).filter((function(r){return r==e(t.innerText)})).length?"":n),t.className+=" title-has-anchor",t.querySelector(".title-anchor").id=t.dataset.id,t.querySelector(".title-sub-anchor").id=t.dataset.id})),this.catalog={},this.catalog.id=this.attrs.post.data.id,n().current.data.stream.posts().find((function(e){return e.data.id==t.catalog.id})).catalog=this.catalog,this.catalog.elements=Array.prototype.slice.call(this.element.querySelectorAll(".Post-body :is(h1, h2, h3, h4, h5, h6,.sub-anchor)")),this.catalog.content=this.catalog.elements.map((function(e){var r=-1!=Array(e.classList).map((function(t){return t.value})).indexOf("sub-anchor"),a=r?e.id:e.dataset.id,o=window.location.origin+"/d/"+t.attrs.post.data.relationships.discussion.data.id+"/"+t.attrs.post.data.attributes.number+"#"+a,s=m("p",null," ",m("a",{href:o,target:"_self","data-number":t.attrs.post.data.attributes.number,"data-isAnchor":r,"data-id":a,"data-tag":e.tagName,onclick:function(t){return t.preventDefault(),n().current.data.stream.goToNumber(s.dom.dataset.number).then((function(){setTimeout((function(){window.location.hash="#"+a,setTimeout((function(){m.redraw()}),100)}),250)})),!1}},e.innerText+"\n"));return s}))})),(0,a.extend)(p().prototype,"view",(function(t){if(n().current){try{var e,r,a,o,s,i,l,u;null!=(e=n().current)&&null!=(r=e.data)&&null!=(a=r.stream)&&null!=(o=a.posts().find((function(t){var e,r;return(null==(e=t.data)?void 0:e.id)==(null==(r=n().current.data.stream.posts()[Math.floor(n().current.data.stream.index-n().current.data.stream.visibleStart)-1>0?Math.floor(n().current.data.stream.index-n().current.data.stream.visibleStart)-1:0].data)?void 0:r.id)})).catalog)&&o.content.length&&t.children.push(m("div",{class:"catalog-icon-mobile",onclick:function(){document.querySelector(".PostStreamScrubber.Dropdown.App-titleControl>button.Button.Dropdown-toggle:first-child").click()}})),t.children.push(m("div",{class:"catalog-top"},null==n()||null==(s=n().current)||null==(i=s.data)||null==(l=i.stream)||null==(u=l.posts().find((function(t){var e,r,a,o,s,i,l,u,c,d,m,p,h,f,w,v,g;return(null==t||null==(e=t.data)?void 0:e.id)==(null==(r=n().current)||null==(a=r.data)||null==(o=a.stream)||null==(s=o.posts()[Math.floor((null==(i=n().current)||null==(l=i.data)||null==(u=l.stream)?void 0:u.index)-(null==(c=n().current)||null==(d=c.data)||null==(m=d.stream)?void 0:m.visibleStart))-1>0?Math.floor((null==(p=n().current)||null==(h=p.data)||null==(f=h.stream)?void 0:f.index)-(null==(w=n().current)||null==(v=w.data)||null==(g=v.stream)?void 0:g.visibleStart))-1:0].data)?void 0:s.id)})).catalog)?void 0:u.content))}catch(t){console.log(t)}return t}})),(0,a.override)(c().prototype,"onmatch",(function(t,e,r,a){return n().current.matches(l())&&this.canonicalizeDiscussionSlug(e.id)===this.canonicalizeDiscussionSlug(m.route.param("id"))&&(e.near==m.route.param("near")&&-1!=window.location.href.indexOf("#")||(c().scrollToPostNumber=e.near||1)),this.__proto__.__proto__.onmatch.call(this,e,r,a)})),(0,a.override)(c().prototype,"render",(function(t,e){if(null!==c().scrollToPostNumber){var r=c().scrollToPostNumber;c().scrollToPostNumber==m.route.param("near")&&-1!=window.location.href.indexOf("#")||setTimeout((function(){return n().current.get("stream").goToNumber(r)})),c().scrollToPostNumber=null}return this.__proto__.__proto__.render.call(this,e)})),(0,a.extend)(l().prototype,"show",(function(t){-1!=window.location.href.indexOf("#")&&2==window.location.href.split("#").length&&(setTimeout((function(){window.location.hash="#"+hash}),250),setTimeout((function(){window.location.hash="#"+hash}),500))})),(0,a.override)(l().prototype,"render",(function(t,e){var r,a,o=this;n().history.push("discussion",e.title()),n().setTitle(e.title()),n().setTitleCount(0),console.log("DiscussionPage-overide");var s=[];if(e.payload&&e.payload.included){var i=e.id();s=e.payload.included.filter((function(t){return"posts"===t.type&&t.relationships&&t.relationships.discussion&&!Array.isArray(t.relationships.discussion.data)&&t.relationships.discussion.data.id===i})).map((function(t){return n().store.getById("posts",t.id)})).sort((function(t,e){return t.number()-e.number()})).slice(0,20)}this.stream=new PostStreamState(e,s);var l=m.route.param("near"),u="reply"===l?"reply":parseInt(l);this.stream.goToNumber(u||(null!=(r=null==(a=s[0])?void 0:a.number())?r:0),!0).then((function(){if(o.discussion=e,n().current.set("discussion",e),n().current.set("stream",o.stream),-1!=window.location.href.indexOf("#")&&2==window.location.href.split("#").length){var t=window.location.href.split("#")[1];setTimeout((function(){window.location.hash="#"+t}),1e3),setTimeout((function(){window.location.hash="#"+t}),2e3)}}))})),(0,a.override)(l().prototype,"positionChanged",(function(t,e,r){var a=this.discussion;if(a){var o=n().route.discussion(a,this.near=e)+(window.location.hash.substr(1).split("-")[0]==this.near?window.location.hash:"");window.history.replaceState(null,document.title,o),n().history.push("discussion",a.title()),n().session.user&&r>(a.lastReadPostNumber()||0)&&(a.save({lastReadPostNumber:r}),m.redraw())}})),window.updateCatalogTop=function(){var t,e,r,a,o,s;if(null!=n()&&null!=(t=n().current)&&null!=(e=t.data)&&null!=(r=e.stream)&&r.index){var i=document.querySelector('.PostStream-item[data-index="'+Math.floor((null==n()||null==(a=n().current)||null==(o=a.data)||null==(s=o.stream)?void 0:s.index)-1)+'"] li.item-progress');if(n().current.data.stream.progress=Math.floor(100*(n().current.data.stream.index-Math.floor(n().current.data.stream.index))),i&&(i.innerText=n().current.data.stream.progress+"%",m.redraw(),n().current.data.stream.progress>100-n().current.data.stream.percentScreenPost||n().current.data.stream.progress<n().current.data.stream.percentScreenPost)){var l=document.querySelector(".PostStreamCurrent");if(!l)return;l.className=l.className.replaceAll("PostStreamCurrent","")}}},window.addEventListener("scroll",window.updateCatalogTop),window.addEventListener("touchmove",window.updateCatalogTop),window.updateCurrentPostClass=function(){var t,e,r;if(null!=n()&&null!=(t=n().current)&&null!=(e=t.data)&&null!=(r=e.stream)&&r.index){var a=document.querySelector('.PostStream-item[data-index="'+Math.floor(n().current.data.stream.index-1)+'"]');n().current.data.stream.percentScreenPost=window.innerHeight/a.scrollHeight*100-2;var o=document.querySelector(".PostStreamCurrent");if(a!=o&&a)if(a.scrollHeight<window.innerHeight||n().current.data.stream.progress>100-n().current.data.stream.percentScreenPost||n().current.data.stream.progress<n().current.data.stream.percentScreenPost){if(!o)return;o.className=o.className.replaceAll("PostStreamCurrent","")}else{if(a.className+=" PostStreamCurrent",!o)return;o.className=o.className.replaceAll("PostStreamCurrent","")}}},window.addEventListener("scroll",window.updateCurrentPostClass),window.addEventListener("touchmove",window.updateCurrentPostClass),(0,a.extend)(s().prototype,"actionItems",(function(t){t.add("progress",m("span",null),10)}))}))})(),module.exports=e})();
//# sourceMappingURL=forum.js.map